app-id: com.github.nihui.waifu2x-ncnn-vulkan

runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk

command: waifu2x-ncnn-vulkan

finish-args:
  - --device=dri
  - --filesystem=xdg-pictures

cleanup:
  - '*.a'
  - /include
  - /lib/pkgconfig
  - /lib/*.a
  - /lib/*.la
  - /vulkansdk
  - /bin/protoc

modules:
# ncnn version requirement from waifu2x-ncnn-vulkan README.md
  - name: ncnn
    buildsystem: cmake
    builddir: true
    build-options:
      env:
        VULKAN_SDK: /app/vulkansdk/x86_64
    config-opts:
      - -DNCNN_VULKAN=ON
    sources:
      - type: git
        url: https://github.com/Tencent/ncnn.git
        commit: 8c537069875a28d5380c6bdcbf7964d73803b7b3
    modules:
      - name: protobuf
        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/releases/download/v3.9.1/protobuf-all-3.9.1.tar.gz
            sha256: 3040a5b946d9df7aa89c0bf6981330bf92b7844fd90e71b61da0c721e421a421
      - name: vulkan-sdk
        buildsystem: simple
        build-commands:
          - mkdir -p /app/vulkansdk
          - tar -x --strip-components=1 -f vulkan*.gz -C /app/vulkansdk
        sources:
          - type: file
            url: https://sdk.lunarg.com/sdk/download/1.1.108.0/linux/vulkansdk-linux-x86_64-1.1.108.0.tar.gz?Human=true
            sha256: 686bce4d02875f40e0e88ffedfb5ba0f31ddff6403709fe41e15b2d94914d0ea

  - name: waifu2x-ncnn-vulkan
    buildsystem: cmake
    builddir: true
    build-options:
      env:
        VULKAN_SDK: /app/vulkansdk/x86_64
    sources:
      - type: archive
        url: https://github.com/nihui/waifu2x-ncnn-vulkan/archive/20190712.tar.gz
        sha256: 09f045f3a1f099513b571be216c14412c2f24b0ef2d252901bc262cd4b167ca0
      - type: shell
        commands:
          - >
            sed -r -i -e 's#(models-cunet)#/app/share/\1#'
            -e 's#(models-upconv_7_anime_style_art_rgb)#/app/share/\1#' main.cpp
          - >
            sed -i -e '/# change these path to yours/d'
            -e '/include_directories("\/home\/nihui\/osd\/ncnn\/build\/install\/include")/d'
            -e '/link_directories("\/home\/nihui\/osd\/ncnn\/build\/install\/lib")/d' CMakeLists.txt
          - >
            echo -e '\n
            install(TARGETS waifu2x-ncnn-vulkan DESTINATION bin)\n
            install(DIRECTORY models-cunet DESTINATION share)\n
            install(DIRECTORY models-upconv_7_anime_style_art_rgb DESTINATION share)' >> CMakeLists.txt
    modules:
      - name: appdata
        buildsystem: simple
        build-commands:
          - install -t "${FLATPAK_DEST}/share/appdata" -Dm644 com.github.nihui.waifu2x-ncnn-vulkan.appdata.xml
        sources:
          - type: file
            path: com.github.nihui.waifu2x-ncnn-vulkan.appdata.xml
