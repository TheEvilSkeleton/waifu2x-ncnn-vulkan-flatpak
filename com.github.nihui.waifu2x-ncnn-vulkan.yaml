app-id: com.github.nihui.waifu2x-ncnn-vulkan

runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk

command: waifu2x-ncnn-vulkan

finish-args:
  - --device=dri
  - --filesystem=xdg-pictures

cleanup:
  - '*.a'
  - /include
  - /lib/pkgconfig
  - /lib/*.a
  - /lib/*.la

modules:
# ncnn version requirement from waifu2x-ncnn-vulkan README.md
  - name: ncnn
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DNCNN_VULKAN=ON
      - -DNCNN_BUILD_TOOLS=OFF
    cleanup:
      - '*'
    sources:
      - type: git
        url: https://github.com/Tencent/ncnn.git
        tag: '20200413'
        commit: 5580da45251dbd247dc77a8d4f5a90f40a100e06
    modules:
      - name: protobuf
        cleanup:
          - '*'
        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/archive/v3.11.4.tar.gz
            sha256: a79d19dcdf9139fa4b81206e318e33d245c4c9da1ffed21c87288ed4380426f9
      - name: glslang
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_SHARED_LIBS=OFF
        cleanup:
          - '*'
        sources:
          - type: archive
            url: "https://github.com/KhronosGroup/glslang/archive/8.13.3559.tar.gz"
            sha256: c58fdcf7e00943ba10f9ae565b2725ec9d5be7dab7c8e82cac72fcaa83c652ca

  - name: waifu2x-ncnn-vulkan
    buildsystem: cmake
    builddir: true
    subdir: 'src'
    sources:
      - type: archive
        url: https://github.com/nihui/waifu2x-ncnn-vulkan/archive/20200414.tar.gz
        sha256: e3230db5eb17d0a5712dfbdddd0507c895360c05c2b56cd6d47d231e2200add3
      - type: shell
        commands:
          - >
            sed -r -i -e 's#(models-cunet)#/app/share/models/\1#'
            -e 's#(models-upconv_7_anime_style_art_rgb)#/app/share/models/\1#'
            -e 's#(models-upconv_7_photo)#/app/share/models/\1#' src/main.cpp
          - >
            sed -i -e '/# change these path to yours/d'
            -e '#set(ncnn_DIR "/home/nihui/dev/ncnn/build/install/lib/cmake/ncnn")#d' src/CMakeLists.txt
          - >
            echo -e '\n
            install(TARGETS waifu2x-ncnn-vulkan DESTINATION bin)\n
            install(DIRECTORY ../models DESTINATION share)' >> src/CMakeLists.txt
    modules:
      - name: appdata
        buildsystem: simple
        build-commands:
          - install -t "${FLATPAK_DEST}/share/appdata" -Dm644 com.github.nihui.waifu2x-ncnn-vulkan.appdata.xml
        sources:
          - type: file
            path: com.github.nihui.waifu2x-ncnn-vulkan.appdata.xml
